<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geopolitical Speech Lab - Insights</title>

  <!-- Your single stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <!-- Header / Nav -->
  <header class="site-header">
    <nav class="nav">
      <!-- Brand (2 lines) -->
      <a class="brand" href="index.html">
        <span class="brand-main">Geopolitical Speech Lab</span>
        <span class="brand-sub">Decoding Great Power Speech</span>
      </a>

      <!-- Right-side nav -->
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="insights.html">Insights</a></li>
        <li><a href="alldata.html">Data</a></li>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="our-team/index.html">The Team</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <h1>Insights</h1>

<!-- Keyword-per-year visualization tool -->
<section class="chart-section">
  <div class="chart-card viz-card">
    <h2>Speeches Containing Selected Keywords (per year)</h2>
    <div class="viz-container">
      <div id="kw-chart" class="plotly-chart"></div>

      <aside class="viz-controls">
        <div class="control-row">
          <label for="country-select"><strong>Country</strong></label>
          <select id="country-select" class="dropdown">
            <option value="China">China</option>
            <option value="Russia">Russia</option>
          </select>
        </div>

        <div class="control-row">
          <label><strong>Keywords</strong></label>
          <div id="keywords-list" class="keywords-list"></div>
        </div>

        <div class="control-row">
          <button id="update-btn" class="dropdown">Update chart</button>
        </div>
        <div style="font-size:.85rem;color:#cfe9ff;margin-top:10px">
          Data: data/speech_keyword_hits.csv, data/keywords.csv, data/speeches_processed.csv
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
/* Small CSV parser that respects quoted fields */
function splitCSVLine(line) {
  const parts = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
  return parts.map(s => {
    s = s.trim();
    if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1);
    return s.replace(/\r$/, '');
  });
}

async function loadCSV(url) {
  const txt = await fetch(url).then(r => r.text());
  const lines = txt.split(/\r?\n/).filter(l => l.trim() !== '');
  const header = splitCSVLine(lines[0]);
  const rows = lines.slice(1).map(l => {
    const cols = splitCSVLine(l);
    const obj = {};
    for (let i = 0; i < header.length; i++) obj[header[i]] = cols[i] ?? '';
    return obj;
  });
  return { header, rows };
}

function uniqSorted(arr) {
  return Array.from(new Set(arr)).sort((a,b) => +a - +b);
}

function createKeywordsCheckboxes(keywordMap) {
  const container = document.getElementById('keywords-list');
  container.innerHTML = '';
  // render as checkboxes
  Object.entries(keywordMap).forEach(([id, label]) => {
    const idSafe = 'kw_' + id;
    const row = document.createElement('div');
    row.style.marginBottom = '6px';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = idSafe;
    cb.value = id;
    cb.checked = false;
    const lab = document.createElement('label');
    lab.htmlFor = idSafe;
    lab.style.marginLeft = '6px';
    lab.textContent = label;
    row.appendChild(cb);
    row.appendChild(lab);
    container.appendChild(row);
  });
}

function getSelectedKeywordIds() {
  return Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]:checked')).map(i => i.value);
}

function buildCounts(hitsRows, idToCountry, selectedCountry, selectedKeywordIds) {
  // hitsRows: {id,keyword,year}
  const yearSet = new Set();
  const countsByKw = {};
  selectedKeywordIds.forEach(k => countsByKw[k] = {});
  for (const r of hitsRows) {
    const sid = r.id;
    const country = idToCountry[sid];
    if (!country) continue;
    if (country !== selectedCountry) continue;
    if (!selectedKeywordIds.includes(r.keyword)) continue;
    const y = String(r.year).replace('.0','');
    yearSet.add(y);
    countsByKw[r.keyword][y] = (countsByKw[r.keyword][y] || 0) + 1;
  }
  const years = Array.from(yearSet).map(y=>+y).sort((a,b)=>a-b);
  return { years, countsByKw };
}

function drawPlot(years, countsByKw, keywordMap) {
  const traces = Object.keys(countsByKw).map(kid => {
    const counts = years.map(y => countsByKw[kid][String(y)] || 0);
    return {
      x: years,
      y: counts,
      mode: 'lines+markers',
      name: keywordMap[kid] || kid,
      line: { width: 2 },
      marker: { size: 6 }
    };
  });
  const layout = {
    title: 'Number of speeches per year containing selected keywords',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Number of speeches' },
    hovermode: 'x unified',
    margin: { b: 50, l: 60, r: 20, t: 60 },
    legend: { orientation: 'v', xanchor: 'left', x: 1.02 },
    autosize: true
  };
  Plotly.react('kw-chart', traces, layout, { responsive: true });
}

async function initKeywordViz() {
  const [hitsCsv, kwCsv, speechesCsv] = await Promise.all([
    loadCSV('data/speech_keyword_hits.csv'),
    loadCSV('data/keywords.csv'),
    loadCSV('data/speeches_processed.csv')
  ]);

  // build keyword map: keywords.csv has header like "",x  or first column is id
  const keywordMap = {};
  for (const r of kwCsv.rows) {
    // some files have header names ambiguous; try to pick id by the first header column
    const keys = Object.keys(r);
    const id = r[keys[0]];
    const label = r[keys[1]] || r[keys[0]];
    if (id) keywordMap[id] = label;
  }

  // build id -> country map from speeches_processed.csv (id column and country column)
  const idToCountry = {};
  for (const r of speechesCsv.rows) {
    // header names: id,country,...
    const sid = r['id'] ?? r['"id"'] ?? r['ID'] ?? r[Object.keys(r)[0]];
    const country = r['country'] ?? r['"country"'] ?? r['Country'] ?? r[Object.keys(r)[1]];
    if (sid) idToCountry[sid] = country;
  }

  // normalize hits rows: ensure we have id,keyword,year keys
  const hits = hitsCsv.rows.map(r => {
    const keys = Object.keys(r);
    const id = r['id'] ?? r[keys[0]];
    const keyword = r['keyword'] ?? r[keys[1]];
    const year = r['year'] ?? r[keys[2]];
    return { id: String(id), keyword: String(keyword), year: year };
  });

  createKeywordsCheckboxes(keywordMap);

  const countrySelect = document.getElementById('country-select');
  const updateBtn = document.getElementById('update-btn');

  function refresh() {
    const country = countrySelect.value;
    const selectedKs = getSelectedKeywordIds();
    if (selectedKs.length === 0) {
      // draw empty chart
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style=\"color:#cfe9ff;padding:20px\">Select one or more keywords to show trend</div>';
      return;
    }
    const { years, countsByKw } = buildCounts(hits, idToCountry, country, selectedKs);
    if (years.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style=\"color:#cfe9ff;padding:20px\">No data for this selection</div>';
      return;
    }
    drawPlot(years, countsByKw, keywordMap);
  }

  updateBtn.addEventListener('click', refresh);
  // handy: update when country changes
  countrySelect.addEventListener('change', refresh);

  // initial helpful selection: select top 6 keywords (first ones)
  const boxes = Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]'));
  boxes.slice(0,6).forEach(cb => cb.checked = true);
  refresh();
}

window.addEventListener('load', initKeywordViz);
</script>

<style>
.viz-container { display:flex; gap:20px; align-items:flex-start; justify-content:center; flex-wrap:wrap; }
#kw-chart { flex: 1 1 720px; min-width:420px; height:520px; }
.viz-controls { width:300px; background:rgba(10,14,26,0.3); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); }
.viz-controls .control-row { margin-bottom:12px; }
.keywords-list { max-height:380px; overflow:auto; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.06); }
.viz-card { display:block; }\n</style>

  <style>
.viz-container { display:flex; gap:20px; align-items:flex-start; justify-content:space-between; flex-wrap:nowrap; }
#kw-chart { flex: 1 1 auto; min-width:520px; height:520px; }
.viz-controls { width:320px; flex: 0 0 320px; background:rgba(10,14,26,0.3); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); box-sizing: border-box; }
.viz-controls .control-row { margin-bottom:12px; }
.keywords-list { max-height:380px; overflow:auto; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.06); }
.viz-card { display:block; }

@media (max-width: 1000px) {
  .viz-container { flex-wrap:wrap; flex-direction:column; }
  #kw-chart { min-width: auto; width:100%; height:420px; }
  .viz-controls { width:100%; flex: none; order:2; margin-top:12px; }
}
</style>
</body>
</html>

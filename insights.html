<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geopolitical Speech Lab - Insights</title>

  <!-- Your single stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <!-- Header / Nav -->
  <header class="site-header">
    <nav class="nav">
      <!-- Brand (2 lines) -->
      <a class="brand" href="index.html">
        <span class="brand-main">Geopolitical Speech Lab</span>
        <span class="brand-sub">Decoding Great Power Speech</span>
      </a>

      <!-- Right-side nav -->
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="insights.html">Insights</a></li>
        <li><a href="alldata.html">Data</a></li>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="our-team/index.html">The Team</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <h1>Insights</h1>

<!-- Keyword-per-year visualization tool -->
<section class="chart-section">
  <div class="chart-card viz-card">
    <h2>Speeches Containing Selected Keywords (per year)</h2>
    <div style="display:flex;gap:10px;margin-bottom:12px;justify-content:center">
      <button id="mode-raw-btn" type="button" style="padding:8px 16px;background:#2a3f5f;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;transition:opacity 0.2s">Raw Count</button>
      <button id="mode-adjusted-btn" type="button" style="padding:8px 16px;background:#3a4a5f;color:#cfe9ff;border:none;border-radius:4px;cursor:pointer;font-weight:600;transition:opacity 0.2s;opacity:0.6">Adjusted* (% of speeches)</button>
    </div>
    <div class="viz-container">
      <div id="kw-chart" class="plotly-chart"></div>

      <aside class="viz-controls">
        <div class="control-row">
          <label><strong>Countries</strong></label>
          <div style="font-size:0.85rem;color:#aaa;margin-bottom:8px">Select one or both</div>
          <div style="display:flex;gap:10px;margin-bottom:12px">
            <button id="country-china-btn" type="button" style="flex:1;padding:8px 12px;background:#2a3f5f;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:600;transition:opacity 0.2s">China</button>
            <button id="country-russia-btn" type="button" style="flex:1;padding:8px 12px;background:#3a4a5f;color:#cfe9ff;border:none;border-radius:4px;cursor:pointer;font-weight:600;transition:opacity 0.2s">Russia**</button>
          </div>
        </div>

        <div class="control-row">
          <label><strong>Keywords</strong></label>
          <div id="keywords-list" class="keywords-list">
            <details style="margin-bottom:12px" open>
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>Continents</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-continents" style="margin-left:12px;margin-top:6px"></div>
            </details>
            <details style="margin-bottom:12px">
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>Areas/Countries</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-areas" style="margin-left:12px;margin-top:6px"></div>
            </details>
            <details style="margin-bottom:12px">
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>International Organizations</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-organizations" style="margin-left:12px;margin-top:6px"></div>
            </details>
            <details style="margin-bottom:12px">
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>Topics</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-topics" style="margin-left:12px;margin-top:6px"></div>
            </details>
            <details style="margin-bottom:12px">
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>Rhetorical Devices</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-rhetorical" style="margin-left:12px;margin-top:6px"></div>
            </details>
            <details style="margin-bottom:12px">
              <summary style="cursor:pointer;font-weight:600;color:#cfe9ff;user-select:none;padding:8px 12px;background:#2a3f5f;border-radius:4px;display:flex;justify-content:space-between;align-items:center"><span>Chinese Concepts</span><span class="count" style="font-size:0.9em;color:#aaa">(0 selected)</span></summary>
              <div id="kw-chineseConcepts" style="margin-left:12px;margin-top:6px"></div>
            </details>
          </div>
        </div>
      </aside>
    </div>
    
    <!-- Technical Notes -->
    <div style="padding:12px 14px;background:#1a3a4a;border-left:4px solid #4a9ba7;margin-top:16px;font-size:0.85rem;color:#aee;border-radius:2px">
      <strong>Usage Notes:</strong> 
      <br>*As Russia's MOFA publishes articles with greater frequency, using the Adjusted button is recommended for comparative analysis. This demonstrates the number of speeches containing the keyword as a a percent of total speeches from that year.</br>
      <br>**Collection of Russian data begins at 2014.</br>
    </div>
  </div>
</section>

<script>
async function loadCache(url) {
  return fetch(url).then(r => r.json());
}

function createKeywordsCheckboxes(keywordMap) {
  // Define keyword categories by ID
  const categories = {
    continents: ['1', '2', '3', '4', '5'],
    areas: ['42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60'],
    organizations: ['6', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41'],
    topics: ['7', '9', '10', '12', '13', '14', '17', '19', '20', '21', '22', '23'],
    rhetorical: ['8', '11', '15', '16', '18', '24', '25', '26', '27', '28', '29', '30'],
    chineseConcepts: ['61', '62', '63', '64', '65', '66', '67', '68', '69', '70']
  };

  function createCheckbox(id, label) {
    const idSafe = 'kw_' + id;
    const row = document.createElement('div');
    row.style.marginBottom = '6px';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = idSafe;
    cb.value = id;
    cb.checked = false;
    const lab = document.createElement('label');
    lab.htmlFor = idSafe;
    lab.style.marginLeft = '6px';
    lab.textContent = label;
    row.appendChild(cb);
    row.appendChild(lab);
    return row;
  }

  // Populate each category
  Object.entries(categories).forEach(([catKey, ids]) => {
    const container = document.getElementById(`kw-${catKey}`);
    if (!container) return;
    ids.forEach(id => {
      if (keywordMap[id]) {
        container.appendChild(createCheckbox(id, keywordMap[id]));
      }
    });
  });
}

function getSelectedKeywordIds() {
  return Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]:checked')).map(i => i.value);
}

function updateSelectionCounts() {
  const categories = {
    continents: ['1', '2', '3', '4', '5'],
    areas: ['42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60'],
    organizations: ['6', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41'],
    topics: ['7', '9', '10', '12', '13', '14', '17', '19', '20', '21', '22', '23'],
    rhetorical: ['8', '11', '15', '16', '18', '24', '25', '26', '27', '28', '29', '30'],
    chineseConcepts: ['61', '62', '63', '64', '65', '66', '67', '68', '69', '70']
  };

  Object.entries(categories).forEach(([catKey, ids]) => {
    const container = document.getElementById(`kw-${catKey}`);
    if (!container) return;
    const summary = container.parentElement.querySelector('summary');
    if (!summary) return;
    const checked = container.querySelectorAll('input[type=checkbox]:checked').length;
    const countSpan = summary.querySelector('.count');
    if (countSpan) {
      countSpan.textContent = `(${checked} selected)`;
    }
  });
}

function buildCounts(countRows, selectedCountries, selectedKeywordIds) {
  // countRows: {year, keyword, country, count}
  const yearSet = new Set();
  const countsByKwAndCountry = {}; // {keyword: {country: {year: count}}}
  
  selectedKeywordIds.forEach(k => {
    countsByKwAndCountry[k] = {};
    selectedCountries.forEach(c => {
      countsByKwAndCountry[k][c] = {};
    });
  });
  
  for (const r of countRows) {
    // Exclude 2026 and Russia data from 2013 and earlier
    const year = Math.floor(parseFloat(r.year));
    if (year === 2026) continue;
    if (r.country === 'Russia' && year <= 2013) continue;
    
    if (!selectedCountries.includes(r.country)) continue;
    if (!selectedKeywordIds.includes(r.keyword)) continue;
    const y = String(year);
    yearSet.add(y);
    if (!countsByKwAndCountry[r.keyword][r.country][y]) {
      countsByKwAndCountry[r.keyword][r.country][y] = 0;
    }
    countsByKwAndCountry[r.keyword][r.country][y] += r.count;
  }
  
  const years = Array.from(yearSet).map(y=>+y).sort((a,b)=>a-b);
  return { years, countsByKwAndCountry };
}

function drawPlot(years, countsByKwAndCountry, keywordMap, selectedCountries, totalSpeechesByYearCountry, normalized) {
  const traces = [];
  const colors = { 'China': '#EF553B', 'Russia': '#636EFA' };
  
  Object.keys(countsByKwAndCountry).forEach(kid => {
    selectedCountries.forEach(country => {
      // For Russia, only plot years where it has actual data to avoid gaps
      let xData = years;
      let yData = years.map(y => {
        let count = countsByKwAndCountry[kid][country][String(y)] || 0;
        if (normalized && totalSpeechesByYearCountry[country] && totalSpeechesByYearCountry[country][String(y)]) {
          const total = totalSpeechesByYearCountry[country][String(y)];
          return total > 0 ? (count / total) * 100 : 0;
        }
        return count;
      });
      
      if (country === 'Russia') {
        // Filter to only include years with data
        const dataPoints = years
          .map((y, i) => ({ year: y, count: yData[i] }))
          .filter(p => p.count > 0);
        xData = dataPoints.map(p => p.year);
        yData = dataPoints.map(p => p.count);
      }
      
      traces.push({
        x: xData,
        y: yData,
        mode: 'lines+markers',
        name: `${keywordMap[kid]} (${country})`,
        line: { width: 2 },
        marker: { size: 6 },
        legendgroup: kid,
        legendgrouptitle: { text: keywordMap[kid] }
      });
    });
  });
  
  const layout = {
    title: normalized ? 'Percentage of speeches per year mentioning selected keywords' : 'Number of speeches per year containing selected keywords',
    xaxis: { title: 'Year' },
    yaxis: { title: normalized ? 'Percentage of speeches (%)' : 'Number of speeches' },
    hovermode: 'x unified',
    margin: { b: 50, l: 60, r: 20, t: 60 },
    legend: { orientation: 'v', xanchor: 'left', x: 1.02 },
    autosize: true
  };
  Plotly.react('kw-chart', traces, layout, { responsive: true });
}

async function initKeywordViz() {
  const cache = await loadCache('data/viz_cache.json');

  const keywordMap = cache.keywords;
  const countRows = cache.counts;

  createKeywordsCheckboxes(keywordMap);

  // Build total speeches per year per country from cache
  const totalSpeechesByYearCountry = { China: {}, Russia: {} };
  for (const t of cache.total_speeches) {
    const year = Math.floor(parseFloat(t.year));
    if (year === 2026) continue;
    if (t.country === 'Russia' && year <= 2013) continue;
    
    const y = String(year);
    totalSpeechesByYearCountry[t.country][y] = t.total_speeches;
  }

  // Track selected countries and mode
  let selectedCountries = { China: true, Russia: false };
  let normalizedMode = false;
  
  const chinaBtn = document.getElementById('country-china-btn');
  const russiaBtn = document.getElementById('country-russia-btn');
  const rawBtn = document.getElementById('mode-raw-btn');
  const adjustedBtn = document.getElementById('mode-adjusted-btn');
  
  function updateButtonStyles() {
    if (selectedCountries.China) {
      chinaBtn.style.background = '#2a3f5f';
      chinaBtn.style.color = 'white';
      chinaBtn.style.opacity = '1';
    } else {
      chinaBtn.style.background = '#3a4a5f';
      chinaBtn.style.color = '#cfe9ff';
      chinaBtn.style.opacity = '0.6';
    }
    
    if (selectedCountries.Russia) {
      russiaBtn.style.background = '#2a3f5f';
      russiaBtn.style.color = 'white';
      russiaBtn.style.opacity = '1';
    } else {
      russiaBtn.style.background = '#3a4a5f';
      russiaBtn.style.color = '#cfe9ff';
      russiaBtn.style.opacity = '0.6';
    }
    
    if (normalizedMode) {
      rawBtn.style.background = '#3a4a5f';
      rawBtn.style.color = '#cfe9ff';
      rawBtn.style.opacity = '0.6';
      adjustedBtn.style.background = '#2a3f5f';
      adjustedBtn.style.color = 'white';
      adjustedBtn.style.opacity = '1';
    } else {
      rawBtn.style.background = '#2a3f5f';
      rawBtn.style.color = 'white';
      rawBtn.style.opacity = '1';
      adjustedBtn.style.background = '#3a4a5f';
      adjustedBtn.style.color = '#cfe9ff';
      adjustedBtn.style.opacity = '0.6';
    }
  }
  
  chinaBtn.addEventListener('click', () => {
    selectedCountries.China = !selectedCountries.China;
    updateButtonStyles();
    refresh();
  });
  
  russiaBtn.addEventListener('click', () => {
    selectedCountries.Russia = !selectedCountries.Russia;
    updateButtonStyles();
    refresh();
  });
  
  rawBtn.addEventListener('click', () => {
    normalizedMode = false;
    updateButtonStyles();
    refresh();
  });
  
  adjustedBtn.addEventListener('click', () => {
    normalizedMode = true;
    updateButtonStyles();
    refresh();
  });

  function refresh() {
    const countriesToShow = [];
    if (selectedCountries.China) countriesToShow.push('China');
    if (selectedCountries.Russia) countriesToShow.push('Russia');
    
    const selectedKs = getSelectedKeywordIds();
    if (selectedKs.length === 0 || countriesToShow.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">Select one or more keywords and countries to show trend</div>';
      return;
    }
    const { years, countsByKwAndCountry } = buildCounts(countRows, countriesToShow, selectedKs);
    if (years.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">No data for this selection</div>';
      return;
    }
    drawPlot(years, countsByKwAndCountry, keywordMap, countriesToShow, totalSpeechesByYearCountry, normalizedMode);
  }

  // auto-update when any keyword checkbox changes
  document.getElementById('keywords-list').addEventListener('change', () => {
    updateSelectionCounts();
    refresh();
  });

  // initial helpful selection: continents only
  const boxes = Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]'));
  const continentIds = ['1', '2', '3', '4', '5'];
  boxes.filter(b => continentIds.includes(b.value)).forEach(cb => cb.checked = true);
  updateSelectionCounts();
  updateButtonStyles();
  refresh();
}

window.addEventListener('load', initKeywordViz);
</script>
 
</body>
</html>

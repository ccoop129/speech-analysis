<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geopolitical Speech Lab - Insights</title>

  <!-- Your single stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <!-- Header / Nav -->
  <header class="site-header">
    <nav class="nav">
      <!-- Brand (2 lines) -->
      <a class="brand" href="index.html">
        <span class="brand-main">Geopolitical Speech Lab</span>
        <span class="brand-sub">Decoding Great Power Speech</span>
      </a>

      <!-- Right-side nav -->
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="insights.html">Insights</a></li>
        <li><a href="alldata.html">Data</a></li>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="our-team/index.html">The Team</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <h1>Insights</h1>

<!-- Keyword-per-year visualization tool -->
<section class="chart-section">
  <div class="chart-card viz-card">
    <h2>Speeches Containing Selected Keywords (per year)</h2>
    <div class="viz-container">
      <div id="kw-chart" class="plotly-chart"></div>

      <aside class="viz-controls">
        <div class="control-row">
          <label for="country-select"><strong>Country</strong></label>
          <select id="country-select" class="dropdown">
            <option value="China">China</option>
            <option value="Russia">Russia</option>
          </select>
        </div>

        <div class="control-row">
          <label><strong>Keywords</strong></label>
          <div id="keywords-list" class="keywords-list"></div>
        </div>

        <div style="font-size:.85rem;color:#cfe9ff;margin-top:10px">
          Data: data/viz_cache.json
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
async function loadCache(url) {
  return fetch(url).then(r => r.json());
}

function createKeywordsCheckboxes(keywordMap) {
  const container = document.getElementById('keywords-list');
  container.innerHTML = '';
  Object.entries(keywordMap).forEach(([id, label]) => {
    const idSafe = 'kw_' + id;
    const row = document.createElement('div');
    row.style.marginBottom = '6px';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = idSafe;
    cb.value = id;
    cb.checked = false;
    const lab = document.createElement('label');
    lab.htmlFor = idSafe;
    lab.style.marginLeft = '6px';
    lab.textContent = label;
    row.appendChild(cb);
    row.appendChild(lab);
    container.appendChild(row);
  });
}

function getSelectedKeywordIds() {
  return Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]:checked')).map(i => i.value);
}

function buildCounts(countRows, idToCountry, selectedCountry, selectedKeywordIds) {
  // countRows: {year, keyword, country, count}
  const yearSet = new Set();
  const countsByKw = {};
  selectedKeywordIds.forEach(k => countsByKw[k] = {});
  
  for (const r of countRows) {
    if (r.country !== selectedCountry) continue;
    if (!selectedKeywordIds.includes(r.keyword)) continue;
    const y = String(Math.floor(parseFloat(r.year)));
    yearSet.add(y);
    countsByKw[r.keyword][y] = (countsByKw[r.keyword][y] || 0) + r.count;
  }
  const years = Array.from(yearSet).map(y=>+y).sort((a,b)=>a-b);
  return { years, countsByKw };
}

function drawPlot(years, countsByKw, keywordMap) {
  const traces = Object.keys(countsByKw).map(kid => {
    const counts = years.map(y => countsByKw[kid][String(y)] || 0);
    return {
      x: years,
      y: counts,
      mode: 'lines+markers',
      name: keywordMap[kid] || kid,
      line: { width: 2 },
      marker: { size: 6 }
    };
  });
  const layout = {
    title: 'Number of speeches per year containing selected keywords',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Number of speeches' },
    hovermode: 'x unified',
    margin: { b: 50, l: 60, r: 20, t: 60 },
    legend: { orientation: 'v', xanchor: 'left', x: 1.02 },
    autosize: true
  };
  Plotly.react('kw-chart', traces, layout, { responsive: true });
}

async function initKeywordViz() {
  const cache = await loadCache('data/viz_cache.json');

  const keywordMap = cache.keywords;
  const idToCountry = cache.id_country;
  const countRows = cache.counts;

  createKeywordsCheckboxes(keywordMap);

  const countrySelect = document.getElementById('country-select');

  function refresh() {
    const country = countrySelect.value;
    const selectedKs = getSelectedKeywordIds();
    if (selectedKs.length === 0) {
      // draw empty chart
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">Select one or more keywords to show trend</div>';
      return;
    }
    const { years, countsByKw } = buildCounts(countRows, idToCountry, country, selectedKs);
    if (years.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">No data for this selection</div>';
      return;
    }
    drawPlot(years, countsByKw, keywordMap);
  }

  // handy: update when country changes
  countrySelect.addEventListener('change', refresh);
  // auto-update when any keyword checkbox changes
  document.getElementById('keywords-list').addEventListener('change', refresh);

  // initial helpful selection: all continents checked
  const boxes = Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]'));
  const continentIds = ['1', '2', '3', '4', '5']; // Asia, Africa, North America, South America, Europe
  boxes.filter(b => continentIds.includes(b.value)).forEach(cb => cb.checked = true);
  refresh();
}

window.addEventListener('load', initKeywordViz);
</script>
 
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geopolitical Speech Lab - Insights</title>

  <!-- Your single stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
  <!-- Header / Nav -->
  <header class="site-header">
    <nav class="nav">
      <!-- Brand (2 lines) -->
      <a class="brand" href="index.html">
        <span class="brand-main">Geopolitical Speech Lab</span>
        <span class="brand-sub">Decoding Great Power Speech</span>
      </a>

      <!-- Right-side nav -->
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a class="active" href="insights.html">Insights</a></li>
        <li><a href="alldata.html">Data</a></li>
        <li><a href="faq.html">FAQ</a></li>
        <li><a href="our-team/index.html">The Team</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <h1>Insights</h1>

<!-- Keyword-per-year visualization tool -->
<section class="chart-section">
  <div class="chart-card viz-card">
    <h2>Speeches Containing Selected Keywords (per year)</h2>
    <div class="viz-container">
      <div id="kw-chart" class="plotly-chart"></div>

      <aside class="viz-controls">
        <div class="control-row">
          <label><strong>Countries</strong></label>
          <div style="display:flex;gap:15px;margin-bottom:12px">
            <div>
              <input type="checkbox" id="country-china" value="China" checked>
              <label for="country-china" style="margin-left:6px">China</label>
            </div>
            <div>
              <input type="checkbox" id="country-russia" value="Russia">
              <label for="country-russia" style="margin-left:6px">Russia</label>
            </div>
          </div>
        </div>

        <div class="control-row">
          <label><strong>Keywords</strong></label>
          <div id="keywords-list" class="keywords-list"></div>
        </div>

        <div style="font-size:.85rem;color:#cfe9ff;margin-top:10px">
          Data: data/viz_cache.json
        </div>
      </aside>
    </div>
  </div>
</section>

<script>
async function loadCache(url) {
  return fetch(url).then(r => r.json());
}

function createKeywordsCheckboxes(keywordMap) {
  const container = document.getElementById('keywords-list');
  container.innerHTML = '';
  Object.entries(keywordMap).forEach(([id, label]) => {
    const idSafe = 'kw_' + id;
    const row = document.createElement('div');
    row.style.marginBottom = '6px';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = idSafe;
    cb.value = id;
    cb.checked = false;
    const lab = document.createElement('label');
    lab.htmlFor = idSafe;
    lab.style.marginLeft = '6px';
    lab.textContent = label;
    row.appendChild(cb);
    row.appendChild(lab);
    container.appendChild(row);
  });
}

function getSelectedKeywordIds() {
  return Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]:checked')).map(i => i.value);
}

function buildCounts(countRows, selectedCountries, selectedKeywordIds) {
  // countRows: {year, keyword, country, count}
  const yearSet = new Set();
  const countsByKwAndCountry = {}; // {keyword: {country: {year: count}}}
  
  selectedKeywordIds.forEach(k => {
    countsByKwAndCountry[k] = {};
    selectedCountries.forEach(c => {
      countsByKwAndCountry[k][c] = {};
    });
  });
  
  for (const r of countRows) {
    if (!selectedCountries.includes(r.country)) continue;
    if (!selectedKeywordIds.includes(r.keyword)) continue;
    const y = String(Math.floor(parseFloat(r.year)));
    yearSet.add(y);
    if (!countsByKwAndCountry[r.keyword][r.country][y]) {
      countsByKwAndCountry[r.keyword][r.country][y] = 0;
    }
    countsByKwAndCountry[r.keyword][r.country][y] += r.count;
  }
  
  const years = Array.from(yearSet).map(y=>+y).sort((a,b)=>a-b);
  return { years, countsByKwAndCountry };
}

function drawPlot(years, countsByKwAndCountry, keywordMap, selectedCountries) {
  const traces = [];
  const colors = { 'China': '#EF553B', 'Russia': '#636EFA' };
  
  Object.keys(countsByKwAndCountry).forEach(kid => {
    selectedCountries.forEach(country => {
      const counts = years.map(y => countsByKwAndCountry[kid][country][String(y)] || 0);
      traces.push({
        x: years,
        y: counts,
        mode: 'lines+markers',
        name: `${keywordMap[kid]} (${country})`,
        line: { width: 2 },
        marker: { size: 6 },
        legendgroup: kid,
        legendgrouptitle: { text: keywordMap[kid] }
      });
    });
  });
  
  const layout = {
    title: 'Number of speeches per year containing selected keywords',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Number of speeches' },
    hovermode: 'x unified',
    margin: { b: 50, l: 60, r: 20, t: 60 },
    legend: { orientation: 'v', xanchor: 'left', x: 1.02 },
    autosize: true
  };
  Plotly.react('kw-chart', traces, layout, { responsive: true });
}

async function initKeywordViz() {
  const cache = await loadCache('data/viz_cache.json');

  const keywordMap = cache.keywords;
  const countRows = cache.counts;

  createKeywordsCheckboxes(keywordMap);

  function refresh() {
    const selectedCountries = [];
    if (document.getElementById('country-china').checked) selectedCountries.push('China');
    if (document.getElementById('country-russia').checked) selectedCountries.push('Russia');
    
    const selectedKs = getSelectedKeywordIds();
    if (selectedKs.length === 0 || selectedCountries.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">Select one or more keywords and countries to show trend</div>';
      return;
    }
    const { years, countsByKwAndCountry } = buildCounts(countRows, selectedCountries, selectedKs);
    if (years.length === 0) {
      Plotly.purge('kw-chart');
      document.getElementById('kw-chart').innerHTML = '<div style="color:#cfe9ff;padding:20px">No data for this selection</div>';
      return;
    }
    drawPlot(years, countsByKwAndCountry, keywordMap, selectedCountries);
  }

  // update when country checkboxes change
  document.getElementById('country-china').addEventListener('change', refresh);
  document.getElementById('country-russia').addEventListener('change', refresh);
  // auto-update when any keyword checkbox changes
  document.getElementById('keywords-list').addEventListener('change', refresh);

  // initial helpful selection: all continents checked
  const boxes = Array.from(document.querySelectorAll('#keywords-list input[type=checkbox]'));
  const continentIds = ['1', '2', '3', '4', '5']; // Asia, Africa, North America, South America, Europe
  boxes.filter(b => continentIds.includes(b.value)).forEach(cb => cb.checked = true);
  refresh();
}

window.addEventListener('load', initKeywordViz);
</script>
 
</body>
</html>
